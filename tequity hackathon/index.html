<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Health Assistant for Seniors</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #74E6D3 0%, #4DD0E1 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* ===== LANDING PAGE STYLES ===== */
        .landing-page {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            text-align: center;
            position: relative;
        }
        
        .landing-page::before {
            content: '';
            position: absolute;
            width: 400px;
            height: 400px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            top: -100px;
            right: -100px;
            animation: float 6s ease-in-out infinite;
        }
        
        .landing-page::after {
            content: '';
            position: absolute;
            width: 300px;
            height: 300px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 50%;
            bottom: -80px;
            left: -80px;
            animation: float 8s ease-in-out infinite reverse;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(5deg); }
        }
        
        .landing-content {
            position: relative;
            z-index: 10;
            max-width: 600px;
            padding: 0 20px;
        }
        
        .landing-logo {
            font-size: 5rem;
            margin-bottom: 30px;
            animation: pulse 2s infinite;
        }
        
        .landing-title {
            font-size: 3rem;
            font-weight: 300;
            color: white;
            margin-bottom: 20px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .landing-subtitle {
            font-size: 1.3rem;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 50px;
            line-height: 1.6;
        }
        
        .language-selection {
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 25px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
            backdrop-filter: blur(10px);
        }
        
        .language-title {
            font-size: 1.5rem;
            color: #333;
            margin-bottom: 25px;
            font-weight: 600;
        }
        
        .language-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .language-option {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .language-option:hover {
            background: #74E6D3;
            border-color: #4DD0E1;
            color: white;
            transform: translateY(-2px);
        }
        
        .language-option.selected {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-color: #667eea;
            color: white;
        }
        
        .language-flag {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .language-name {
            font-weight: 600;
            font-size: 1rem;
        }
        
        .continue-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 18px 40px;
            border-radius: 25px;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }
        
        .continue-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.4);
        }
        
        .continue-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        /* ===== MAIN APP STYLES ===== */
        .main-app {
            display: none;
        }
        
        .header {
            background: linear-gradient(135deg, #74E6D3 0%, #4DD0E1 100%);
            color: white;
            padding: 30px 20px;
            text-align: left;
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 300px;
            height: 300px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            transform: translate(100px, -100px);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
            z-index: 10;
        }
        
        .header-text h1 {
            font-size: 2.4rem;
            font-weight: 300;
            margin-bottom: 10px;
        }
        
        .header-text p {
            font-size: 1rem;
            opacity: 0.9;
            max-width: 500px;
        }
        
        .language-indicator {
            background: rgba(255, 255, 255, 0.2);
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 1rem;
            font-weight: 500;
        }
        
        .checkmark {
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
        }
        
        .main-content {
            background: #f8f9fa;
            min-height: calc(100vh - 200px);
            padding: 30px 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .voice-section {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .voice-btn {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 15px 35px rgba(102, 126, 234, 0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 0 auto 20px;
            position: relative;
            overflow: hidden;
        }
        
        .voice-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>') no-repeat center;
            background-size: 80px 80px;
            opacity: 0.9;
        }
        
        .voice-btn:hover {
            transform: scale(1.05);
        }
        
        .voice-btn.recording {
            background: linear-gradient(135deg, #ff4757, #c44569);
            animation: pulse 1s infinite;
        }
        
        .voice-btn.recording::before {
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M6 6h12v12H6z"/></svg>') no-repeat center;
            background-size: 60px 60px;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.08); }
            100% { transform: scale(1); }
        }
        
        .voice-label {
            font-size: 1.2rem;
            font-weight: 600;
            position: relative;
            z-index: 10;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .voice-status {
            margin-top: 15px;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 0.95rem;
            font-weight: 500;
        }
        
        .status-ready {
            background: #d4edda;
            color: #155724;
        }
        
        .status-listening {
            background: #fff3cd;
            color: #856404;
        }
        
        .chat-window {
            max-width: 900px;
            margin: 30px auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            height: 450px;
            display: flex;
            flex-direction: column;
        }
        
        .chat-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 20px 20px 0 0;
            font-weight: 600;
            font-size: 1.1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .clear-chat-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        
        .clear-chat-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            max-height: 320px;
        }
        
        .message {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
        }
        
        .user-message {
            justify-content: flex-end;
        }
        
        .message-bubble {
            max-width: 75%;
            padding: 15px 20px;
            border-radius: 18px;
            font-size: 1rem;
            line-height: 1.5;
            position: relative;
        }
        
        .user-bubble {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .ai-bubble {
            background: #f1f3f4;
            color: #333;
            border: 1px solid #e0e0e0;
        }
        
        .message-actions {
            margin-top: 10px;
            display: flex;
            gap: 8px;
        }
        
        .chat-input-area {
            padding: 15px 20px;
            border-top: 1px solid #eee;
            display: flex;
            gap: 10px;
        }
        
        .chat-input {
            flex: 1;
            padding: 15px 20px;
            border: 1px solid #ddd;
            border-radius: 25px;
            font-size: 1rem;
            outline: none;
            transition: all 0.3s ease;
        }
        
        .chat-input:focus {
            border-color: #74E6D3;
            box-shadow: 0 0 0 3px rgba(116, 230, 211, 0.1);
        }
        
        .send-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            font-size: 1.3rem;
            transition: all 0.3s ease;
        }
        
        .send-btn:hover {
            transform: scale(1.05);
        }
        
        .content-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 30px;
        }
        
        .section {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        .section-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .upload-area {
            border: 2px dashed #74E6D3;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            background: #f8fdfc;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }
        
        .upload-area:hover {
            background: #f0faf9;
            border-color: #4DD0E1;
        }
        
        .upload-area.dragover {
            background: #e8f8f5;
            border-color: #26C6DA;
            transform: scale(1.02);
        }
        
        .upload-icon {
            font-size: 2.5rem;
            color: #74E6D3;
            margin-bottom: 15px;
        }
        
        .file-input {
            display: none;
        }
        
        .uploaded-files {
            margin-top: 20px;
        }
        
        .file-item {
            background: linear-gradient(135deg, #74E6D3, #4DD0E1);
            color: white;
            padding: 15px 20px;
            border-radius: 25px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 10px 0;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .file-item:hover {
            transform: translateX(5px);
        }
        
        .file-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .file-size {
            font-size: 0.8rem;
            opacity: 0.8;
        }
        
        .remove-file-btn {
            background: rgba(255, 255, 255, 0.3);
            border: none;
            color: white;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            cursor: pointer;
            font-size: 1.2rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .remove-file-btn:hover {
            background: rgba(255, 100, 100, 0.8);
            transform: scale(1.1);
        }
        
        .analyze-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }
        
        .analyze-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        
        .analyze-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .result-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border-left: 4px solid #74E6D3;
            transition: all 0.3s ease;
        }
        
        .result-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }
        
        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .result-title {
            font-weight: 600;
            color: #333;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .priority-badge {
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .high-priority {
            background: #ffe6e6;
            color: #d63384;
        }
        
        .medium-priority {
            background: #fff3cd;
            color: #f57c00;
        }
        
        .result-text {
            color: #666;
            line-height: 1.6;
            font-size: 1rem;
            margin-bottom: 15px;
        }
        
        .result-actions {
            display: flex;
            gap: 10px;
        }
        
        .speak-btn, .mark-done-btn {
            padding: 10px 18px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .speak-btn {
            background: #ff9f43;
            color: white;
            border: none;
        }
        
        .speak-btn:hover {
            background: #ff7675;
        }
        
        .mark-done-btn {
            background: transparent;
            border: 2px solid #74E6D3;
            color: #74E6D3;
        }
        
        .mark-done-btn:hover {
            background: #74E6D3;
            color: white;
        }
        
        .loading {
            text-align: center;
            color: #666;
            padding: 40px 20px;
        }
        
        .loading-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
            animation: bounce 1s infinite;
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-8px); }
            60% { transform: translateY(-4px); }
        }
        
        .database-status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 12px 18px;
            border-radius: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            font-size: 0.9rem;
            font-weight: 500;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }
        
        .db-connected {
            color: #28a745;
        }
        
        .db-disconnected {
            color: #dc3545;
        }
        
        .hidden {
            display: none !important;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #f5c6cb;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #c3e6cb;
        }
        
        @media (max-width: 768px) {
            .content-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .header-content {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .voice-btn {
                width: 160px;
                height: 160px;
            }
            
            .chat-window {
                height: 400px;
                margin: 20px auto;
            }
            
            .language-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .landing-title {
                font-size: 2.2rem;
            }
        }
    </style>
</head>
<body>
    <div class="landing-page" id="landingPage">
        <div class="landing-content">
            <div class="landing-logo">🏥</div>
            <h1 class="landing-title">AI Health Assistant</h1>
            <p class="landing-subtitle">Your personal healthcare companion powered by artificial intelligence</p>
            
            <div class="language-selection">
                <h2 class="language-title">Choose Your Preferred Language</h2>
                <div class="language-grid" id="languageGrid">
                    <div class="language-option" data-lang="en-US">
                        <div class="language-flag">🇺🇸</div>
                        <div class="language-name">English</div>
                    </div>
                    <div class="language-option" data-lang="es-ES">
                        <div class="language-flag">🇪🇸</div>
                        <div class="language-name">Español</div>
                    </div>
                    <div class="language-option" data-lang="fr-FR">
                        <div class="language-flag">🇫🇷</div>
                        <div class="language-name">Français</div>
                    </div>
                    <div class="language-option" data-lang="de-DE">
                        <div class="language-flag">🇩🇪</div>
                        <div class="language-name">Deutsch</div>
                    </div>
                    <div class="language-option" data-lang="hi-IN">
                        <div class="language-flag">🇮🇳</div>
                        <div class="language-name">हिंदी</div>
                    </div>
                    <div class="language-option" data-lang="zh-CN">
                        <div class="language-flag">🇨🇳</div>
                        <div class="language-name">中文</div>
                    </div>
                </div>
                <button class="continue-btn" id="continueBtn" disabled>Continue to Health Assistant</button>
            </div>
        </div>
    </div>

    <div class="main-app" id="mainApp">
        <div class="database-status" id="dbStatus">
            <span class="db-connected">🟢 Database Connected</span>
        </div>

        <div class="header">
            <div class="header-content">
                <div class="header-text">
                    <h1 id="welcomeText">Welcome back, Sarah!</h1>
                    <p id="subtitleText">Your AI health assistant is ready to help in your preferred language.</p>
                </div>
                
                <div style="display: flex; align-items: center; gap: 20px;">
                    <div class="language-indicator" id="currentLangDisplay">🇺🇸 English</div>
                    <div class="checkmark">✓</div>
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="container">
                <div class="voice-section">
                    <button class="voice-btn" id="voiceBtn">
                        <div class="voice-label" id="voiceLabel">Press & Speak</div>
                    </button>
                    <div class="voice-status status-ready" id="voiceStatus">Ready to listen</div>
                </div>
                
                <div class="chat-window">
                    <div class="chat-header">
                        <span id="chatTitle">💬 Chat with Your Health Assistant</span>
                        <button class="clear-chat-btn" id="clearChatBtn">Clear Chat</button>
                    </div>
                    <div class="chat-messages" id="chatMessages">
                        <div class="message">
                            <div class="message-bubble ai-bubble">
                                <strong>AI Assistant:</strong> <span id="aiGreeting">Hello! I'm here to help with your health questions. You can speak to me or type your questions. How can I assist you today?</span>
                            </div>
                        </div>
                    </div>
                    <div class="chat-input-area">
                        <input type="text" class="chat-input" id="chatInput" placeholder="Type your health question here...">
                        <button class="send-btn" id="sendBtn">➤</button>
                    </div>
                </div>
                
                <div class="content-grid">
                    <div class="section">
                        <h3 class="section-title">
                            📄 <span id="uploadTitle">Upload Medical Reports</span>
                        </h3>
                        
                        <div class="upload-area" id="uploadArea">
                            <div class="upload-icon">📁</div>
                            <p style="font-size: 1.1rem; margin-bottom: 8px; font-weight: 500;" id="uploadText">Drop your medical reports here</p>
                            <p style="color: #666; font-size: 0.9rem;" id="uploadSubtext">or click to browse files</p>
                            <p style="color: #888; font-size: 0.8rem; margin-top: 8px;">Max 20 files • 50MB per file • PDF, JPG, PNG, DOC</p>
                            <input type="file" class="file-input" id="fileInput" multiple accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
                        </div>
                        <div class="uploaded-files" id="uploadedFiles"></div>
                        
                        <button class="analyze-btn" id="analyzeBtn">
                            🔍 <span id="analyzeText">Analyze My Health Information</span>
                        </button>
                    </div>
                    
                    <div class="section">
                        <h3 class="section-title">
                            💡 <span id="resultsTitle">Your Health Insights</span>
                        </h3>
                        
                        <div class="results-container" id="resultsContainer">
                            <div class="loading">
                                <div style="font-size: 2.2rem; margin-bottom: 15px; color: #74E6D3;">🩺</div>
                                <p style="font-weight: 500;" id="waitingText">Upload reports and ask questions to get personalized insights!</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // 🔗 n8n Production Webhook URL (workflow must be Activated in n8n)
        const N8N_WEBHOOK_URL = "https://abhishektailor.app.n8n.cloud/webhook/b4818cda-6adc-49f6-a0a3-e5ecceaf7c47";
        
        // Global variables
        let recognition = null;
        let isRecording = false;
        let uploadedFilesList = [];
        let currentQuestion = '';
        let selectedLanguage = '';
        let chatHistory = [];
        let hasSpokenWelcome = false;
        
        // Database simulation
        let database = {
            users: [],
            sessions: [],
            conversations: []
        };
        
        // Language translations
        const translations = {
            'en-US': {
                welcome: 'Welcome back, Sarah!',
                subtitle: 'Your AI health assistant is ready to help in your preferred language.',
                pressSpeak: 'Press & Speak',
                readyListen: 'Ready to listen',
                listening: 'Listening...',
                chatPlaceholder: 'Type your health question here...',
                aiGreeting: 'Hello! I\'m here to help with your health questions. You can speak to me or type your questions. How can I assist you today?',
                chatTitle: 'Chat with Your Health Assistant',
                uploadTitle: 'Upload Medical Reports',
                uploadText: 'Drop your medical reports here',
                uploadSubtext: 'or click to browse files',
                analyzeText: 'Analyze My Health Information',
                resultsTitle: 'Your Health Insights',
                waitingText: 'Upload reports and ask questions to get personalized insights!',
                welcomeAnnouncement: 'Welcome to the online AI powered health care app'
            },
            'es-ES': {
                welcome: '¡Bienvenida de nuevo, Sarah!',
                subtitle: 'Tu asistente de salud con IA está listo para ayudarte en tu idioma preferido.',
                pressSpeak: 'Presiona y Habla',
                readyListen: 'Listo para escuchar',
                listening: 'Escuchando...',
                chatPlaceholder: 'Escribe tu pregunta de salud aquí...',
                aiGreeting: '¡Hola! Estoy aquí para ayudarte con tus preguntas de salud. ¿Cómo puedo asistirte hoy?',
                chatTitle: 'Chatea con tu Asistente de Salud',
                uploadTitle: 'Subir Reportes Médicos',
                uploadText: 'Arrastra tus reportes médicos aquí',
                uploadSubtext: 'o haz clic para buscar archivos',
                analyzeText: 'Analizar Mi Información de Salud',
                resultsTitle: 'Tus Conocimientos de Salud',
                waitingText: '¡Sube reportes y haz preguntas para obtener información personalizada!',
                welcomeAnnouncement: 'Bienvenido a la aplicación de atención médica en línea impulsada por IA'
            },
            'hi-IN': {
                welcome: 'वापस स्वागत है, सारा!',
                subtitle: 'आपका AI स्वास्थ्य सहायक आपकी पसंदीदा भाषा में मदद के लिए तैयार है।',
                pressSpeak: 'दबाएं और बोलें',
                readyListen: 'सुनने के लिए तैयार',
                listening: 'सुन रहा है...',
                chatPlaceholder: 'यहां अपना स्वास्थ्य प्रश्न लिखें...',
                aiGreeting: 'नमस्ते! मैं आपके स्वास्थ्य प्रश्नों में मदद के लिए यहां हूं। आज मैं आपकी कैसे सहायता कर सकता हूं?',
                chatTitle: 'अपने स्वास्थ्य सहायक से चैट करें',
                uploadTitle: 'मेडिकल रिपोर्ट अपलोड करें',
                uploadText: 'अपनी मेडिकल रिपोर्ट यहां छोड़ें',
                uploadSubtext: 'या फ़ाइलें ब्राउज़ करने के लिए क्लिक करें',
                analyzeText: 'मेरी स्वास्थ्य जानकारी का विश्लेषण करें',
                resultsTitle: 'आपकी स्वास्थ्य अंतर्दृष्टि',
                waitingText: 'व्यक्तिगत अंतर्दृष्टि प्राप्त करने के लिए रिपोर्ट अपलोड करें और प्रश्न पूछें!',
                welcomeAnnouncement: 'ऑनलाइन AI संचालित स्वास्थ्य देखभाल एप में आपका स्वागत है'
            }
        };
        
        // Initialize language selection
        document.querySelectorAll('.language-option').forEach(option => {
            option.addEventListener('click', () => {
                document.querySelectorAll('.language-option').forEach(opt => opt.classList.remove('selected'));
                option.classList.add('selected');
                selectedLanguage = option.dataset.lang;
                document.getElementById('continueBtn').disabled = false;
            });
        });
        
        // Continue to main app
        document.getElementById('continueBtn').addEventListener('click', () => {
            document.getElementById('landingPage').classList.add('hidden');
            document.getElementById('mainApp').style.display = 'block';
            
            // Update language and speak welcome
            updateLanguage();
            setTimeout(() => {
                speakWelcomeMessage();
            }, 1000);
            
            // Initialize speech recognition with selected language
            initializeSpeechRecognition();
            
            // Save session to database
            saveToDatabase('session_start', {
                language: selectedLanguage,
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent
            });
        });
        
        function updateLanguage() {
            const trans = translations[selectedLanguage] || translations['en-US'];
            
            document.getElementById('welcomeText').textContent = trans.welcome;
            document.getElementById('subtitleText').textContent = trans.subtitle;
            document.getElementById('voiceLabel').textContent = trans.pressSpeak;
            document.getElementById('voiceStatus').textContent = trans.readyListen;
            document.getElementById('chatInput').placeholder = trans.chatPlaceholder;
            document.getElementById('aiGreeting').textContent = trans.aiGreeting;
            document.getElementById('chatTitle').textContent = '💬 ' + trans.chatTitle;
            document.getElementById('uploadTitle').textContent = trans.uploadTitle;
            document.getElementById('uploadText').textContent = trans.uploadText;
            document.getElementById('uploadSubtext').textContent = trans.uploadSubtext;
            document.getElementById('analyzeText').textContent = trans.analyzeText;
            document.getElementById('resultsTitle').textContent = trans.resultsTitle;
            document.getElementById('waitingText').textContent = trans.waitingText;
            
            // Update language indicator
            const langInfo = {
                'en-US': '🇺🇸 English',
                'es-ES': '🇪🇸 Español',
                'hi-IN': '🇮🇳 हिंदी',
                'zh-CN': '🇨🇳 中文',
                'fr-FR': '🇫🇷 Français',
                'de-DE': '🇩🇪 Deutsch'
            };
            document.getElementById('currentLangDisplay').textContent = langInfo[selectedLanguage] || '🇺🇸 English';
        }
        
        function speakWelcomeMessage() {
            if (!hasSpokenWelcome && 'speechSynthesis' in window) {
                const trans = translations[selectedLanguage] || translations['en-US'];
                const utterance = new SpeechSynthesisUtterance(trans.welcomeAnnouncement);
                utterance.lang = selectedLanguage;
                utterance.rate = 0.8;
                utterance.pitch = 1;
                speechSynthesis.speak(utterance);
                hasSpokenWelcome = true;
            }
        }
        
        function initializeSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = true;
                recognition.lang = selectedLanguage;
                
                setupVoiceHandlers();
            }
        }
        
        function setupVoiceHandlers() {
            const voiceBtn = document.getElementById('voiceBtn');
            const voiceStatus = document.getElementById('voiceStatus');
            
            voiceBtn.addEventListener('click', () => {
                if (isRecording) {
                    recognition.stop();
                } else {
                    recognition.start();
                }
            });
            
            recognition.onstart = () => {
                isRecording = true;
                voiceBtn.classList.add('recording');
                document.getElementById('voiceLabel').textContent = 'Stop Recording';
                voiceStatus.className = 'voice-status status-listening';
                voiceStatus.textContent = translations[selectedLanguage]?.listening || 'Listening...';
            };
            
            recognition.onresult = (event) => {
                let transcript = '';
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    transcript += event.results[i][0].transcript;
                }
                currentQuestion = transcript;
                addChatMessage(transcript, 'user');
                
                // Save voice input to database
                saveToDatabase('voice_input', {
                    transcript: transcript,
                    language: selectedLanguage,
                    timestamp: new Date().toISOString()
                });
                
                // Send to webhook instead of mock response
                sendToWebhook(transcript, 'voice');
            };
            
            recognition.onend = () => {
                isRecording = false;
                voiceBtn.classList.remove('recording');
                const trans = translations[selectedLanguage] || translations['en-US'];
                document.getElementById('voiceLabel').textContent = trans.pressSpeak;
                voiceStatus.className = 'voice-status status-ready';
                voiceStatus.textContent = trans.readyListen;
            };
            
            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                showErrorMessage('Voice recognition error. Please try typing instead.');
                isRecording = false;
                voiceBtn.classList.remove('recording');
            };
        }
        
        // FIXED: Send data to webhook with timeout and proper response handling
        async function sendToWebhook(message, inputType = 'chat') {
            try {
                showTypingIndicator();
                
                const payload = {
                    message: message,
                    language: selectedLanguage,
                    inputType: inputType,
                    chatHistory: chatHistory,
                    uploadedFiles: uploadedFilesList.map(file => ({
                        name: file.name,
                        size: file.size,
                        type: file.type
                    })),
                    sessionId: getSessionId(),
                    timestamp: new Date().toISOString()
                };
                
                console.log('Sending to webhook:', payload);
                
                // Add timeout to prevent hanging
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout
                
                console.log('body', JSON.stringify(payload));
                const response = await fetch(N8N_WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                console.log('res', response);

                const result = await response.json();
                console.log('Webhook response:', result);
                
                removeTypingIndicator();
                
                // FIXED: Handle different response keys more flexibly
                let aiResponseContent = result.response || result.message || result.answer;
                
                // Added a check for 'myField' to handle the specific user error
                if (!aiResponseContent && result.myField) {
                    aiResponseContent = result.myField;
                }
                
                if (aiResponseContent) {
                    addChatMessage(aiResponseContent, 'ai');
                    
                    // Add to chat history
                    chatHistory.push({
                        role: 'assistant',
                        content: aiResponseContent,
                        timestamp: new Date().toISOString()
                    });
                } else {
                    // Fallback for unexpected response structure
                    console.warn('Unexpected webhook response structure. Displaying raw JSON.');
                    addChatMessage(`${JSON.stringify(result, null, 2)}`, 'ai');
                }
                
                // FIXED: Update Health Insights section
                if (result.healthInsights || result.analysis || result.insights || result.recommendations) {
                    const insights = result.healthInsights || result.analysis || result.insights || result.recommendations;
                    displayHealthInsights(insights);
                }
                
                // Save successful webhook call
                saveToDatabase('webhook_success', {
                    message: message,
                    response: result,
                    language: selectedLanguage
                });
                
            } catch (error) {
                removeTypingIndicator();
                
                if (error.name === 'AbortError') {
                    console.error('Request timed out');
                    addChatMessage('Request timed out. Please try again.', 'ai');
                    showErrorMessage('Request timed out after 30 seconds. Please try again.');
                } else {
                    console.error('Webhook error:', error);
                    addChatMessage('Sorry, I encountered an error processing your request. Please try again.', 'ai');
                    showErrorMessage('Failed to connect to AI service. Please check your connection.');
                }
                
                saveToDatabase('webhook_error', {
                    message: message,
                    error: error.message,
                    language: selectedLanguage
                });
            }
        }
        
        // FIXED: Send files to webhook for analysis with timeout
        async function sendFilesToWebhook() {
            try {
                const formData = new FormData();
                
                // Add basic data
                formData.append('language', selectedLanguage);
                formData.append('sessionId', getSessionId());
                formData.append('requestType', 'file_analysis');
                formData.append('currentQuestion', currentQuestion);
                formData.append('chatHistory', JSON.stringify(chatHistory));
                formData.append('generateInsights', 'true'); // Flag for n8n workflow
                
                // Add files
                uploadedFilesList.forEach((file, index) => {
                    formData.append(`file_${index}`, file);
                });
                
                console.log('Sending files to webhook...');
                
                // Add timeout for file processing
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 60000); // 60 seconds for file processing
                
                const response = await fetch(N8N_WEBHOOK_URL, {
                    method: 'POST',
                    body: formData,
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('File analysis response:', result);
                
                // FIXED: Display the analysis results in the insights section
                if (result.analysis || result.insights || result.healthInsights || result.recommendations) {
                    const insights = result.analysis || result.insights || result.healthInsights || result.recommendations;
                    displayHealthInsights(insights);
                } else if (result.message || result.response) {
                    displayHealthInsights(result.message || result.response);
                } else {
                    displayHealthInsights('File analysis completed successfully. The AI has processed your medical reports.');
                }
                
                saveToDatabase('file_analysis_success', {
                    fileCount: uploadedFilesList.length,
                    response: result,
                    language: selectedLanguage
                });
                
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.error('File analysis timed out');
                    displayHealthInsights('File analysis timed out. Please try again with smaller files.');
                } else {
                    console.error('File analysis error:', error);
                    displayHealthInsights('File analysis failed. Please check your files and try again.');
                }
                
                saveToDatabase('file_analysis_error', {
                    error: error.message,
                    language: selectedLanguage
                });
            }
        }
        
        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message typing-indicator';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = `
                <div class="message-bubble ai-bubble">
                    <strong>AI Assistant:</strong> <span>Thinking...</span>
                    <div style="margin-top: 5px;">
                        <span style="animation: blink 1.5s infinite;">●</span>
                        <span style="animation: blink 1.5s infinite 0.5s;">●</span>
                        <span style="animation: blink 1.5s infinite 1s;">●</span>
                    </div>
                </div>
            `;
            
            // Add CSS for blinking animation
            if (!document.getElementById('typingAnimation')) {
                const style = document.createElement('style');
                style.id = 'typingAnimation';
                style.textContent = `
                    @keyframes blink {
                        0%, 50% { opacity: 0.3; }
                        25% { opacity: 1; }
                    }
                `;
                document.head.appendChild(style);
            }
            
            document.getElementById('chatMessages').appendChild(typingDiv);
            document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
        }
        
        function removeTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }
        
        // Chat functionality
        function addChatMessage(message, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender === 'user' ? 'user-message' : ''}`;
            
            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = `message-bubble ${sender === 'user' ? 'user-bubble' : 'ai-bubble'}`;
            
            if (sender === 'user') {
                bubbleDiv.innerHTML = `${message}`;
            } else {
                bubbleDiv.innerHTML = `<strong>AI Assistant:</strong> ${message}`;
                
                // Add action buttons for AI messages
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'message-actions';
                actionsDiv.innerHTML = `
                    <button class="speak-btn" onclick="speakText('${message.replace(/'/g, "\\'")}')">🔊 Read</button>
                `;
                bubbleDiv.appendChild(actionsDiv);
            }
            
            messageDiv.appendChild(bubbleDiv);
            document.getElementById('chatMessages').appendChild(messageDiv);
            document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
            
            // Save to chat history and database
            if (sender === 'user') {
                chatHistory.push({ 
                    role: 'user', 
                    content: message, 
                    timestamp: new Date().toISOString() 
                });
            }
            
            saveToDatabase('chat_message', { 
                sender, 
                message, 
                language: selectedLanguage 
            });
        }
        
        // Chat input handlers
        document.getElementById('sendBtn').addEventListener('click', sendChatMessage);
        document.getElementById('chatInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendChatMessage();
            }
        });
        
        function sendChatMessage() {
            const message = document.getElementById('chatInput').value.trim();
            if (message) {
                addChatMessage(message, 'user');
                document.getElementById('chatInput').value = '';
                currentQuestion = message;
                
                // Send to webhook instead of mock response
                sendToWebhook(message, 'chat');
            }
        }
        
        // Clear chat functionality
        document.getElementById('clearChatBtn').addEventListener('click', () => {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = `
                <div class="message">
                    <div class="message-bubble ai-bubble">
                        <strong>AI AssistanYY</strong> <span>${translations[selectedLanguage]?.aiGreeting || 'Hello! How can I help you today?'}</span>
                    </div>
                </div>
            `;
            chatHistory = [];
            saveToDatabase('chat_cleared', { language: selectedLanguage });
        });
        
        // File upload handlers
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        
        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });
        
        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });
        
        function handleFiles(files) {
            Array.from(files).forEach(file => {
                // Check file size limit (50MB)
                if (file.size > 50 * 1024 * 1024) {
                    showErrorMessage(`File "${file.name}" is too large. Maximum size is 50MB.`);
                    return;
                }
                
                // Check total files limit (20 files)
                if (uploadedFilesList.length >= 20) {
                    showErrorMessage('Maximum 20 files allowed. Please remove some files first.');
                    return;
                }
                
                // Check if file already exists
                if (!uploadedFilesList.some(f => f.name === file.name && f.size === file.size)) {
                    uploadedFilesList.push(file);
                    displayFiles();
                    
                    // Save file upload to database
                    saveToDatabase('file_upload', {
                        fileName: file.name,
                        fileSize: file.size,
                        fileType: file.type,
                        language: selectedLanguage
                    });
                }
            });
        }
        
        function displayFiles() {
            const uploadedFiles = document.getElementById('uploadedFiles');
            uploadedFiles.innerHTML = '';
            
            uploadedFilesList.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                
                const fileSize = formatFileSize(file.size);
                const fileName = file.name.length > 25 ? file.name.substring(0, 25) + '...' : file.name;
                
                fileItem.innerHTML = `
                    <div class="file-info">
                        <span>📄 ${fileName}</span>
                        <span class="file-size">(${fileSize})</span>
                    </div>
                    <button class="remove-file-btn" onclick="removeFile(${index})" title="Remove file">×</button>
                `;
                uploadedFiles.appendChild(fileItem);
            });
            
            // Show file count
            const fileCount = document.createElement('div');
            fileCount.style.cssText = 'margin-top: 15px; font-size: 0.9rem; color: #666; text-align: center;';
            fileCount.textContent = `${uploadedFilesList.length}/20 files uploaded`;
            uploadedFiles.appendChild(fileCount);
        }
        
        function removeFile(index) {
            const removedFile = uploadedFilesList[index];
            uploadedFilesList.splice(index, 1);
            displayFiles();
            
            // Save file removal to database
            saveToDatabase('file_removed', {
                fileName: removedFile.name,
                language: selectedLanguage
            });
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // FIXED: Analysis function - now uses webhook with proper timeout
        document.getElementById('analyzeBtn').addEventListener('click', async () => {
            if (!currentQuestion && uploadedFilesList.length === 0) {
                showErrorMessage('Please ask a question or upload medical reports first!');
                return;
            }
            
            const analyzeBtn = document.getElementById('analyzeBtn');
            analyzeBtn.disabled = true;
            analyzeBtn.innerHTML = '🔄 <span>Analyzing...</span>';
            
            document.getElementById('resultsContainer').innerHTML = `
                <div class="loading">
                    <div class="loading-icon">🤖</div>
                    <p style="font-weight: 600; margin-bottom: 10px;">AI is analyzing your health information...</p>
                    <p style="font-size: 0.9rem; color: #888;">Processing with advanced medical AI models</p>
                </div>
            `;
            
            // Save analysis request to database
            saveToDatabase('analysis_request', {
                question: currentQuestion,
                fileCount: uploadedFilesList.length,
                files: uploadedFilesList.map(f => ({ name: f.name, size: f.size })),
                language: selectedLanguage
            });
            
            try {
                // Send to webhook for analysis - specify this is for insights
                if (uploadedFilesList.length > 0) {
                    await sendFilesToWebhook();
                } else {
                    // For text-only analysis, add a flag to indicate this should generate insights
                    await sendToWebhook(currentQuestion + ' [REQUEST_HEALTH_INSIGHTS]', 'analysis');
                }
            } catch (error) {
                console.error('Analysis error:', error);
                displayHealthInsights('Analysis failed. Please try again.');
            } finally {
                analyzeBtn.disabled = false;
                analyzeBtn.innerHTML = '🔍 <span>' + (translations[selectedLanguage]?.analyzeText || 'Analyze My Health Information') + '</span>';
            }
        });
        
        // FIXED: Enhanced function to handle different insight formats from n8n workflow
        function displayHealthInsights(insights) {
            const resultsContainer = document.getElementById('resultsContainer');
            
            // Handle different insight formats from n8n workflow
            let insightContent = '';
            let insightTitle = 'AI Health Analysis';
            
            if (typeof insights === 'string') {
                insightContent = insights;
            } else if (typeof insights === 'object') {
                if (insights.summary) {
                    insightContent = insights.summary;
                    insightTitle = insights.title || 'Health Summary';
                } else if (insights.recommendations && Array.isArray(insights.recommendations)) {
                    insightContent = '• ' + insights.recommendations.join('<br>• ');
                    insightTitle = 'Health Recommendations';
                } else {
                    // Fallback for unknown object structure
                    insightContent = Object.entries(insights)
                        .map(([key, value]) => `<strong>${key}:</strong> ${value}`)
                        .join('<br>');
                }
            } else {
                insightContent = String(insights);
            }
            
            // Clean up HTML entities and format properly
            insightContent = insightContent
                .replace(/\n/g, '<br>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>');
            
            resultsContainer.innerHTML = `
                <div class="result-card">
                    <div class="result-header">
                        <div class="result-title">
                            🩺 ${insightTitle}
                        </div>
                        <span class="priority-badge medium-priority">
                            Analysis Complete
                        </span>
                    </div>
                    <div class="result-text">${insightContent}</div>
                    <div class="result-actions">
                        <button class="speak-btn" onclick="speakText('${insightContent.replace(/<[^>]*>/g, '').replace(/'/g, "\\'")}')">
                            🔊 Read Aloud
                        </button>
                        <button class="mark-done-btn" onclick="markAsDone(this)">
                            ✓ Mark as Done
                        </button>
                    </div>
                    <div style="margin-top: 15px; font-size: 0.9rem; color: #718096;">
                        Analysis completed at ${new Date().toLocaleString()}
                    </div>
                </div>
            `;
            
            // Save result to database
            saveToDatabase('analysis_result', {
                insights: insights,
                language: selectedLanguage,
                timestamp: new Date().toISOString()
            });
        }
        
        // Text-to-speech function with language support
        function speakText(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = selectedLanguage;
                utterance.rate = 0.8;
                utterance.pitch = 1;
                utterance.volume = 1;
                speechSynthesis.speak(utterance);
                
                // Save TTS usage to database
                saveToDatabase('text_to_speech', {
                    text: text,
                    language: selectedLanguage
                });
            } else {
                showErrorMessage('Text-to-speech not supported in this browser');
            }
        }
        
        function markAsDone(button) {
            const resultCard = button.closest('.result-card');
            resultCard.style.opacity = '0.6';
            button.textContent = '✅ Done';
            button.disabled = true;
            
            saveToDatabase('task_completed', {
                taskTitle: resultCard.querySelector('.result-title').textContent,
                language: selectedLanguage
            });
        }
        
        // Error and success message functions
        function showErrorMessage(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            
            // Insert at the top of the main content
            const mainContent = document.querySelector('.main-content .container');
            mainContent.insertBefore(errorDiv, mainContent.firstChild);
            
            // Remove after 5 seconds
            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }
        
        function showSuccessMessage(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            successDiv.textContent = message;
            
            // Insert at the top of the main content
            const mainContent = document.querySelector('.main-content .container');
            mainContent.insertBefore(successDiv, mainContent.firstChild);
            
            // Remove after 3 seconds
            setTimeout(() => {
                successDiv.remove();
            }, 3000);
        }
        
        // Database Functions (JSON format storage)
        function saveToDatabase(eventType, data) {
            const record = {
                id: generateId(),
                eventType: eventType,
                data: data,
                timestamp: new Date().toISOString(),
                sessionId: getSessionId(),
                language: selectedLanguage
            };
            
            // Add to local database simulation
            database.conversations.push(record);
            
            console.log('Saving to database:', record);
            updateDatabaseStatus();
        }
        
        function generateId() {
            return 'id_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
        }
        
        function getSessionId() {
            if (!window.sessionId) {
                window.sessionId = 'session_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
            }
            return window.sessionId;
        }
        
        function updateDatabaseStatus() {
            const dbStatus = document.getElementById('dbStatus');
            const recordCount = database.conversations.length;
            
            if (recordCount > 0) {
                dbStatus.innerHTML = `<span class="db-connected">🟢 Database Connected (${recordCount} records)</span>`;
            } else {
                dbStatus.innerHTML = `<span class="db-disconnected">🔴 Database Disconnected</span>`;
            }
        }
        
        // Export database function (for testing)
        function exportDatabase() {
            const dataStr = JSON.stringify(database, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `health_assistant_data_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
        }
        
        // Initialize database status
        updateDatabaseStatus();
        
        // Add keyboard shortcut for database export (Ctrl+D)
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'd') {
                e.preventDefault();
                exportDatabase();
            }
        });
        
        // Test webhook connection on page load (optional)
        function testWebhookConnection() {
            console.log('Testing webhook connection...');
            fetch(N8N_WEBHOOK_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    test: true,
                    message: 'Connection test',
                    timestamp: new Date().toISOString()
                })
            })
            .then(response => {
                if (response.ok) {
                    console.log('Webhook connection successful');
                    showSuccessMessage('AI Assistant connected successfully!');
                } else {
                    console.error('Webhook connection failed:', response.status);
                }
            })
            .catch(error => {
                console.error('Webhook connection error:', error);
            });
        }
        
        // Uncomment the line below to test connection when app starts
        // testWebhookConnection();
    </script>
</body>
</html>              